# Переменные ссылочных типов

В языке программирования C# существуют два основных вида типов данных: **значимые типы** (value types) 
и **ссылочные типы** (reference types). Они различаются тем, как данные хранятся в памяти и как они передаются в методы.

Переменные типов значений вы уже должны были изучить. А вот ссылочные типы мы будем изучать гораздо дольше поскольку это
требует изучения ООП (объектно ориентированного программирования).

В этом разделе мы лишь слегка познакомимся с ними чтобы вы имели представление.

Для этого сперва надо понять разницу между типами значений и ссылочными типами.

## Разница между типами значений и ссылочными типами

### 1. **Типы значений**
Значимые типы хранят свои данные прямо в переменной. Если переменная значимого типа копируется, создается новая 
независимая копия данных.

#### Хранение в памяти:
- Данные типа значения хранятся в **стеке** (stack).
- Каждый экземпляр типа значения имеет свою собственную копию данных.

#### Примеры:
- Примитивные типы: `int`, `float`, `double`, `bool`, `char`.
- Структуры (`struct`): Например, `DateTime`, `Point`.
- Перечисления (`enum`).

#### Пример кода:
```c#
int a = 10;
int b = a; // Копируется значение
b = 20;
Console.WriteLine(a); // 10, значение a не изменилось
```

#### Особенности:
- **Локальность:** Значимые типы используют стек, что делает операции с ними быстрыми.
- **Изолированность:** Копирование значимого типа создает независимый объект.

### 2. **Ссылочные типы** {id="2_1"}
Ссылочные типы хранят не сами данные, а **ссылку** (адрес) на область памяти в куче (heap), где данные находятся.

#### Хранение в памяти:
- Ссылка (указатель на объект) хранится в **стеке**.
- Сам объект размещается в **куче**, которая используется для долгосрочного хранения.

#### Примеры:
- Классы (`class`).
- Интерфейсы (`interface`).
- Делегаты (`delegate`).
- Строки (`string`).

#### Пример кода:
```c#
class Person { public string Name; }

Person p1 = new Person { Name = "Alice" };
Person p2 = p1; // Копируется ссылка
p2.Name = "Bob"; // Изменяется объект через ссылку
Console.WriteLine(p1.Name); // Bob, объект один и тот же
```

#### Особенности:
- **Общая ссылка:** При копировании ссылочного типа передается ссылка, а не сам объект. Поэтому изменения через одну переменную видны через другую.
- **Гибкость:** Ссылочные типы позволяют работать с большими и сложными структурами данных.

### 3. **Сравнение типов значений и ссылочных типов** {id="3_1"}

| **Характеристика**        | **Типы значений**                          | **Ссылочные типы**                    |
|---------------------------|--------------------------------------------|---------------------------------------|
| **Хранение данных**       | В памяти переменной (в стеке).             | В куче, ссылка в стеке.              |
| **Копирование**           | Создает копию данных.                     | Копирует ссылку на объект.           |
| **Передача в методы**     | Передается копия данных.                  | Передается копия ссылки.             |
| **Примеры**               | `int`, `double`, `bool`, `DateTime`.       | `string`, массивы, классы, делегаты. |
| **Изменение объекта**     | Не влияет на другие переменные.            | Видимо для всех ссылок на объект.    |

### 4. **Особенности переменных ссылочного типа** {id="4_1"}
Переменная ссылочного типа хранит **только ссылку** на область памяти в куче, где находится объект. Это приводит к тому, что:
- При присваивании другой переменной передается ссылка, а не сам объект.
- Если объект изменяется через одну ссылку, эти изменения видны через все другие ссылки на этот объект.

Время практики, падаван.

Создай консольное приложение `ex0041_ref_types` при помощи шаблона `tinyconsole` в папке
`episode02` и добавь его в файл решения `episode02.sln`. Это можно сделать как в командной строке, так и в любой IDE.

Приведите `Program.cs` к следующему виду:

```c#
class Program
{
    static void Main()
    {
        // Пример типа значения
        int value1 = 10;
        int value2 = value1;
        value2 += 5;
        WriteLine($"Тип значения: value1 = {value1}, value2 = {value2}"); // value1 = 10, value2 = 15

        // Пример ссылочного типа Class
        Person p1 = new Person { Name = "Alice" };
        Person p2 = p1; // Копируется ссылка на объект
        p2.Name = "Bob";
        WriteLine($"Ссылочный тип: p1.Name = {p1.Name}, p2.Name = {p2.Name}"); // p1.Name = Bob, p2.Name = Bob
    }
}

class Person
{
    public string Name;
}
```

Вывод программы:

```
Тип значения: value1 = 10, value2 = 15
Ссылочный тип: p1.Name = Bob, p2.Name = Bob
```

#### Объяснение:
1. **Тип значения (`int`):**
    - `value1` хранит значение `10`.
    - При присваивании `value2 = value1` копируется **само значение**, а не ссылка.
    - Изменение `value2` не затрагивает `value1`.

2. **Ссылочный тип (`Person`):**
    - `p1` хранит ссылку на объект `Person` в куче.
    - При присваивании `p2 = p1` копируется ссылка. Теперь обе переменные указывают на один и тот же объект.
    - Изменение объекта через `p2` влияет на `p1`.

### Вывод:
- **Типы значений** используются для простых данных, которые копируются без связи друг с другом.
- **Ссылочные типы** позволяют работать с объектами в куче, но требуют внимательности, так как изменения через одну ссылку видны через все остальные ссылки на этот объект.

## Виды ссылочных типов

В C# ссылочные типы условно разделают на два вида: пользовательские и [встроенные](https://learn.microsoft.com/ru-ru/dotnet/csharp/language-reference/builtin-types/reference-types).

Встроенные ссылочные типы, включая массивы, выделяют из-за их уникальных свойств, поддержки на уровне языка и 
универсального применения. Пользовательские типы дают разработчикам возможность определять сложные структуры данных, 
которых нет в стандартной библиотеке.

Теперь подробнее о каждом из видов.

## Встроенные ссылочные типы

В C# встроенные ссылочные типы (такие как `object`, `string`, `dynamic` и массивы) выделяются в отдельную категорию, поскольку они обладают особыми характеристиками, встроенными в язык, и играют ключевую роль в базовой инфраструктуре .NET. Рассмотрим их отличия от пользовательских ссылочных типов, таких как `class`, `interface`, `delegate` и `record`.


### 1. Общие свойства встроенных ссылочных типов {id="1_1"}
Эти типы обеспечивают фундаментальные возможности и широко используются в повседневном программировании. Вот их основные характеристики:

- **`object`**:
   - Это базовый тип для всех типов в C# (включая как ссылочные, так и значимые).
   - Каждый тип неявно наследуется от `object`, что позволяет обрабатывать любые данные через общий интерфейс.
   - Основные методы: `ToString()`, `Equals()`, `GetHashCode()`.

- **`string`**:
   - Тип для работы с неизменяемыми строками.
   - Поддерживает широкий набор операций: конкатенация, подстроки, замена символов и т.д.
   - Имеет оптимизацию на уровне компилятора, например, **интернирование строк** (одинаковые строковые литералы ссылаются на одну область памяти).

- **`dynamic`**:
   - Позволяет выполнять операции, проверяемые только во время выполнения (runtime).
   - Удобен для взаимодействия с COM-объектами, динамическими библиотеками или в сценариях, где строгая типизация мешает гибкости.

- **Массивы**:
   - Особый вид встроенных ссылочных типов, автоматически поддерживаемый компилятором и средой выполнения.
   - Массивы являются объектами, а их элементы могут быть как значимыми, так и ссылочными типами.
   - Поддерживают индексный доступ, многомерность и свойства (например, `Length`).

### 2. Отличия от пользовательских ссылочных типов
Встроенные типы выделяются благодаря своей роли в языке и оптимизациям на уровне CLR (Common Language Runtime).

**Основные особенности встроенных ссылочных типов:**

- **Создание**: Встроенные типы уже определены в .NET и не требуют определения программистом. Пользовательские ссылочные типы (такие как классы, интерфейсы и делегаты) создаются вручную для конкретных задач.
- **Особая поддержка**:
   - Для `string` встроена оптимизация работы с текстами, включая интернирование (для экономии памяти одинаковые строки указывают на одну область памяти).
   - Для `dynamic` компилятор и рантайм обеспечивают поддержку "позднего связывания".
- **Наследование**:
   - Пользовательские классы, интерфейсы и записи могут расширять функциональность, наследуясь друг от друга.
   - `object` не может быть унаследован напрямую, так как это конечный базовый класс для всех типов.
   - `string` и `dynamic` являются запечатанными (sealed) и не могут быть унаследованы.
- **Специальные методы и поведение**:
   - Методы `object` доступны для всех типов, включая пользовательские.
   - Для `string` определены перегруженные операторы (`+`, `==` и другие) для удобной работы с текстами.
   - `dynamic` позволяет игнорировать строгую проверку типов компилятором.
- **Функциональсть "из коробки"**. Встроенные типы предоставляют готовую функциональность:
   - `string` предоставляет методы для работы с текстом (Substring, Replace и т.д.).
   - Массивы поддерживают многомерность и обработку данных через `foreach`.
- **Неявная оптимизация**: Типы, такие как `string` и массивы, могут быть оптимизированы на уровне CLR (Common Language Runtime) для повышения производительности.

| **Особенность**            | **Встроенные (object, string, dynamic, массивы)**       | **Пользовательские (class, interface, record, delegate)** |
|-----------------------------|---------------------------------------------------------|----------------------------------------------------------|
| **Определение**            | Часть .NET и языка                                      | Определяются программистом                               |
| **Особая поддержка**       | Методы, оптимизация (интернирование строк, поддержка массивов) | Базовые возможности языка                                |
| **Изменяемость**           | `string` неизменяем, массивы изменяемы                 | Определяется разработчиком                               |
| **Наследование**           | Наследование от `object`, некоторые типы запечатаны     | Возможность создания иерархий классов и интерфейсов      |
| **Расположение в памяти**  | Управляется CLR                                         | Зависит от структуры и логики программы                  |


### 3. Особенности массивов как встроенных ссылочных типов

Массивы относятся к встроенным ссылочным типам. Когда вы создаете массив, переменная хранит ссылку на область памяти в куче, где хранятся элементы массива. Это делает массив ссылочным типом, даже если его элементы – типы значений.

Массивы обладают следующими характеристиками:
- **Ссылочный тип**: Переменная массива хранит ссылку на область памяти в куче, где хранятся его элементы.
- **Автоматическая инициализация**: Элементы массива автоматически инициализируются значениями по умолчанию (`null` для ссылочных типов и `0` для значимых).
- **Свойства и методы**: Массивы предоставляют свойство `Length`, методы `Clone`, `CopyTo`, а также поддерживают цикл `foreach`.

### Примеры использования
#### Встроенные ссылочные типы:
```c#
object obj = 42; // Любой тип может быть сохранён как object
string text = "Привет, мир!";
dynamic dyn = 10;
dyn = "Теперь строка"; // Изменение типа значения динамически

// Массивы
int[] array = new int[] { 1, 2, 3 };
array[1] = 42; // Индексация и изменение элементов
Console.WriteLine(array.Length); // Выводит 3
```

#### Пользовательские ссылочные типы:
```c#
class MyClass
{
    public string Name { get; set; }
}

interface IExample
{
    void DoSomething();
}

record MyRecord(string Name);

delegate void MyDelegate(string message);
```

### 5. Итоговые различия
Встроенные ссылочные типы, включая массивы, выделяются благодаря интеграции в язык и стандартную библиотеку .NET. 
Они предоставляют базовые строительные блоки для программирования. Пользовательские ссылочные типы дают программисту 
возможность создавать структуры для специфических задач.

